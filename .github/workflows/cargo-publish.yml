name: Publish Rust crate

on:
  release:
    # Use released instead of published, since we don't publish preview/beta
    # versions. Users instead install them from the git repo.
    types: [released]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v1.0.0)'
        required: true
        type: string
  pull_request:
    paths:
      - .github/workflows/cargo-publish.yml

env:
  # This env var is used by Swatinem/rust-cache@v2 for the cache
  # key, so we set it to make sure it is always consistent.
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Need up-to-date compilers for kernels
      CC: gcc-12
      CXX: g++-12
    defaults:
      run:
        working-directory: .
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - name: Verify and checkout specified tag
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
        run: |
          git fetch --all --tags
          if git rev-parse ${{ github.event.inputs.tag }} >/dev/null 2>&1; then
            git checkout ${{ github.event.inputs.tag }}
            echo "Successfully checked out tag ${{ github.event.inputs.tag }}"
          else
            echo "Error: Tag ${{ github.event.inputs.tag }} does not exist"
            echo "Available tags:"
            git tag -l
            exit 1
          fi
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y protobuf-compiler libssl-dev
      - uses: albertlockett/publish-crates@v2.2
        if: github.event_name != 'pull_request'
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          args: '--all-features'
          path: .
