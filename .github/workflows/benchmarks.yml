name: Run benchmarks

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    paths:
      - .github/workflows/benchmarks.yml
  schedule:
    - cron: '20 6 * * *'

jobs:
  lance:
    runs-on:
      group: large-runners
      labels: ubuntu-22.04-8core
    timeout-minutes: 120
    defaults:
      run:
        working-directory: ./rust
    steps:
      - uses: actions/checkout@v3
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - name: Install dependencies
        run: |
          sudo apt -qq update
          sudo apt install -y -qq protobuf-compiler libssl-dev pkg-config
          cargo install cargo-codspeed
      - name: Build the benchmark target(s)
        working-directory: rust/lance
        run: cargo codspeed build
      - name: CPU info
        run: cat /proc/cpuinfo | grep -E 'model name|flags' | head -n 2
      - name: Run benchmarks
        uses: CodSpeedHQ/action@v1
        with:
          token: ${{ secrets.CODSPEED_TOKEN }}
          working-directory: rust/lance
          run: cargo codspeed run
  linalg:
    runs-on:
      group: large-runners
      labels: ubuntu-22.04-8core
    timeout-minutes: 120
    defaults:
      run:
        working-directory: ./rust
    steps:
      - uses: actions/checkout@v3
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - name: Install dependencies
        run: |
          sudo apt -qq update
          sudo apt install -y -qq protobuf-compiler libssl-dev pkg-config
          cargo install cargo-codspeed
      - name: Build the benchmark target(s)
        working-directory: rust/lance-linalg
        run: cargo codspeed build
      - name: CPU info
        run: cat /proc/cpuinfo | grep -E 'model name|flags' | head -n 2
      - name: Run benchmarks
        uses: CodSpeedHQ/action@v1
        with:
          token: ${{ secrets.CODSPEED_TOKEN }}
          working-directory: rust/lance-linalg
          run: cargo codspeed run
