name: Run benchmarks

on:
  pull_request:
    paths:
      - .github/workflows/benchmarks.yml
  schedule:
    - cron: '20 6 * * *'

jobs:
  rust:
    runs-on:
      group: large-runners
      labels: ubuntu-22.04-8core
    timeout-minutes: 90
    defaults:
      run:
        working-directory: ./rust
    steps:
      - uses: actions/checkout@v3
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - name: Install dependencies
        run: |
          sudo apt -qq update
          sudo apt install -y -qq protobuf-compiler libssl-dev pkg-config
          cargo install cargo-codspeed
      - name: Build the benchmark target(s)
        run: cargo codspeed build
      - name: CPU info
        run: cat /proc/cpuinfo | grep -E 'model name|flags' | head -n 2
      - name: Run benchmarks
        uses: CodSpeedHQ/action@v1
        with:
          token: ${{ secrets.CODSPEED_TOKEN }}
          working-directory: rust
          run: cargo codspeed run
