name: Create release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      release_channel:
        description: 'Release channel'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - stable
      dry_run:
        description: 'Dry run (simulate the release without pushing)'
        required: true
        default: false
        type: boolean
      draft_release:
        description: 'Create a draft release on GitHub'
        required: true
        default: false
        type: boolean

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    steps:
    - name: Output Inputs
      run: echo "${{ toJSON(github.event.inputs) }}"
    
    - name: Check out main
      uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.LANCE_RELEASE_TOKEN }}
        fetch-depth: 0
        lfs: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        pip install bump-my-version packaging PyGithub
    
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Validate release type against breaking changes
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python ci/check_breaking_changes.py --release-type ${{ inputs.release_type }}
    
    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"
    
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.version }}"
        TYPE="${{ inputs.release_type }}"
        CHANNEL="${{ inputs.release_channel }}"

        # Strip any prerelease suffix to get base version
        BASE_VERSION=$(echo "$CURRENT" | sed 's/-.*$//')
        IFS='.' read -r major minor patch <<< "$BASE_VERSION"

        # Determine if we need to bump the base version
        if [[ "$CHANNEL" == "stable" && "$CURRENT" =~ -beta\. ]]; then
          # Stable release from beta: use base version without bumping
          NEW_VERSION="$BASE_VERSION"
        elif [[ "$CHANNEL" == "preview" && "$CURRENT" =~ -beta\. ]]; then
          # Preview from preview: keep the same base version, only beta number changes
          NEW_VERSION="$BASE_VERSION"
        else
          # All other cases: bump according to type
          case "$TYPE" in
            major)
              NEW_VERSION="$((major + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${major}.$((minor + 1)).0"
              ;;
            patch)
              NEW_VERSION="${major}.${minor}.$((patch + 1))"
              ;;
          esac
        fi

        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version will be: $NEW_VERSION"
    
    - name: Determine tag name and prerelease suffix
      id: tag_name
      run: |
        if [ "${{ inputs.release_channel }}" == "stable" ]; then
          VERSION="${{ steps.new_version.outputs.version }}"
          TAG="v${VERSION}"
          PRERELEASE=""
        else
          # For preview releases, base the beta tag on the next release version
          VERSION="${{ steps.new_version.outputs.version }}"
          # Find the next beta number for upcoming version
          BETA_TAGS=$(git tag -l "v${VERSION}-beta.*" | sort -V)
          if [ -z "$BETA_TAGS" ]; then
            BETA_NUM=1
          else
            LAST_BETA=$(echo "$BETA_TAGS" | tail -n 1)
            LAST_NUM=$(echo "$LAST_BETA" | sed "s/v${VERSION}-beta.//")
            BETA_NUM=$((LAST_NUM + 1))
          fi
          TAG="v${VERSION}-beta.${BETA_NUM}"
          PRERELEASE="beta.${BETA_NUM}"
        fi

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
        echo "Tag will be: $TAG"

    - name: Update version
      run: |
        if [ "${{ inputs.release_channel }}" == "stable" ]; then
          python ci/bump_version.py --new-version "${{ steps.new_version.outputs.version }}"
        else
          python ci/bump_version.py --new-version "${{ steps.new_version.outputs.version }}-${{ steps.tag_name.outputs.prerelease }}"
        fi
    
    - name: Configure git identity
      run: |
        git config user.name 'Lance Release Bot'
        git config user.email 'lance-dev@lancedb.com'

    - name: Create release commit
      run: |
        git add -A
        if [ "${{ inputs.release_channel }}" == "stable" ]; then
          git commit -m "chore: release version ${{ steps.new_version.outputs.version }}"
        else
          git commit -m "chore: release version ${{ steps.tag_name.outputs.tag }}"
        fi
    
    - name: Create tag
      run: |
        git tag -a "${{ steps.tag_name.outputs.tag }}" -m "Release ${{ steps.tag_name.outputs.tag }}"
    
    - name: Push changes (if not dry run)
      if: ${{ !inputs.dry_run }}
      run: |
        # Push the commit to main
        git push origin main
        # Push the tag
        git push origin "${{ steps.tag_name.outputs.tag }}"
    
    - name: Create GitHub Release (if not dry run)
      if: ${{ !inputs.dry_run }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_name.outputs.tag }}
        name: ${{ steps.tag_name.outputs.tag }}
        draft: ${{ inputs.draft_release }}
        prerelease: ${{ inputs.release_channel == 'preview' }}
        generate_release_notes: true
        token: ${{ secrets.LANCE_RELEASE_TOKEN }}
    
    - name: Next steps
      if: ${{ !inputs.dry_run }}
      run: |
        if [ "${{ inputs.release_channel }}" == "stable" ]; then
          echo "Stable release complete. Version bumped to ${{ steps.new_version.outputs.version }}"
        else
          echo "Preview release complete. Version bumped to ${{ steps.new_version.outputs.version }}-${{ steps.tag_name.outputs.prerelease }}"
        fi
    
    - name: Summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Type:** ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Channel:** ${{ inputs.release_channel }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Current Version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New Version:** ${{ steps.new_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** ${{ steps.tag_name.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.dry_run }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ This was a dry run. No changes were pushed." >> $GITHUB_STEP_SUMMARY
        fi
